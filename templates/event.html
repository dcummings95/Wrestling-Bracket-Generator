{% extends "base.html" %}

{% block title %}{{ event.name }} - Brackets{% endblock %}

{% block content %}
<div class="event-page">
    <header class="event-header">
        <div class="event-info">
            <h1>{{ event.name }}</h1>
            <p class="event-date">{{ event.date }}</p>
            <p class="event-stats">
                {{ event.brackets|length }} brackets ¬∑ 
                {{ event.brackets|sum(attribute='size') }} wrestlers ¬∑ 
                {{ event.num_mats }} mats
            </p>
        </div>
        <div class="event-actions">
            <a href="{{ url_for('print_event', event_id=event.id) }}" class="btn btn-secondary" target="_blank">üñ®Ô∏è Print Brackets</a>
            <a href="{{ url_for('print_scoresheets', event_id=event.id) }}" class="btn btn-secondary" target="_blank">üìã Print Scoresheets</a>
            <button onclick="deleteEvent('{{ event.id }}')" class="btn btn-delete">üóëÔ∏è Delete Event</button>
            <a href="{{ url_for('upload') }}" class="btn btn-primary">New Event</a>
        </div>
    </header>

    <div class="mat-tabs">
        <button class="mat-tab active" data-mat="all">All Mats</button>
        {% for i in range(1, event.num_mats + 1) %}
        <button class="mat-tab" data-mat="{{ i }}">Mat {{ i }}</button>
        {% endfor %}
    </div>

    <div class="brackets-grid">
        {% for bracket in event.brackets %}
        <div class="bracket-card" data-mat="{{ bracket.mat_number }}">
            <div class="bracket-header">
                <span class="bracket-id">Bracket {{ bracket.id + 1 }}</span>
                <span class="mat-badge">Mat {{ bracket.mat_number }}</span>
            </div>
            
            {% if bracket.get_relaxation_warnings() %}
            <div class="bracket-warnings">
                {% for warning in bracket.get_relaxation_warnings() %}
                <span class="warning-badge">‚ö†Ô∏è {{ warning }}</span>
                {% endfor %}
            </div>
            {% endif %}

            <div class="bracket-info">
                <span>Weight: {{ bracket.weight_range[0] }} - {{ bracket.weight_range[1] }} lbs</span>
                <span>Grades: {{ bracket.grade_range_display[0] }} - {{ bracket.grade_range_display[1] }}</span>
            </div>

            <table class="bracket-wrestlers">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Gr</th>
                        <th>Wt</th>
                        <th>Rk</th>
                        <th>School</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for w in bracket.wrestlers %}
                    <tr>
                        <td>{{ w.full_name }}</td>
                        <td>{{ w.grade_display }}</td>
                        <td>{{ w.weight }}</td>
                        <td>{{ w.rank }}</td>
                        <td>{{ w.school }}</td>
                        <td>
                            <button class="btn-remove-wrestler" data-event-id="{{ event.id }}" data-bracket-id="{{ bracket.id }}" data-wrestler-id="{{ w.id }}" title="Remove from bracket">‚úï</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

            <div class="matchups">
                <h4>Matchups</h4>
                {% set wrestlers = bracket.wrestlers %}
                {% for i in range(wrestlers|length) %}
                    {% for j in range(i + 1, wrestlers|length) %}
                    <div class="matchup">
                        {{ wrestlers[i].last_name }} vs {{ wrestlers[j].last_name }}
                    </div>
                    {% endfor %}
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>

    {% if event.unmatched_wrestlers %}
    <section class="unmatched-section">
        <h2>‚ö†Ô∏è Unmatched Wrestlers ({{ event.unmatched_wrestlers|length }})</h2>
        <p>These wrestlers could not be placed in a bracket or were manually removed:</p>
        <table class="wrestlers-table">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Grade</th>
                    <th>Weight</th>
                    <th>Rank</th>
                    <th>School</th>
                    <th>Add to Bracket</th>
                </tr>
            </thead>
            <tbody>
                {% for w in event.unmatched_wrestlers %}
                <tr>
                    <td>{{ w.full_name }}</td>
                    <td>{{ w.grade_display }}</td>
                    <td>{{ w.weight }}</td>
                    <td>{{ w.rank }}</td>
                    <td>{{ w.school }}</td>
                    <td>
                        <select class="bracket-select" data-event-id="{{ event.id }}" data-wrestler-id="{{ w.id }}">
                            <option value="">Select bracket...</option>
                            {% for bracket in event.brackets %}
                                {% if bracket.size < 4 %}
                                <option value="{{ bracket.id }}">Bracket {{ bracket.id + 1 }} ({{ bracket.size }}/4)</option>
                                {% endif %}
                            {% endfor %}
                        </select>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </section>
    {% endif %}
</div>

<script>
// Delete event function
function deleteEvent(eventId) {
    if (!confirm('Are you sure you want to delete this event? This cannot be undone.')) {
        return;
    }
    
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = `/event/${eventId}/delete`;
    document.body.appendChild(form);
    form.submit();
}

// Handle removing wrestlers from brackets
document.querySelectorAll('.btn-remove-wrestler').forEach(btn => {
    btn.addEventListener('click', async () => {
        if (!confirm('Remove this wrestler from the bracket?')) return;
        
        const eventId = btn.dataset.eventId;
        const bracketId = btn.dataset.bracketId;
        const wrestlerId = btn.dataset.wrestlerId;
        
        try {
            const response = await fetch(`/api/event/${eventId}/remove-wrestler`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ bracket_id: parseInt(bracketId), wrestler_id: parseInt(wrestlerId) })
            });
            
            if (response.ok) {
                alert('Wrestler removed and added to unmatched section');
                location.reload();
            } else {
                const error = await response.json();
                alert('Error: ' + error.error);
            }
        } catch (err) {
            alert('Error: ' + err.message);
        }
    });
});

// Handle adding wrestlers from unmatched to brackets
document.querySelectorAll('.bracket-select').forEach(select => {
    select.addEventListener('change', async (e) => {
        if (!e.target.value) return;
        
        const eventId = e.target.dataset.eventId;
        const wrestlerId = e.target.dataset.wrestlerId;
        const bracketId = parseInt(e.target.value);
        
        try {
            const response = await fetch(`/api/event/${eventId}/add-wrestler`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ bracket_id: bracketId, wrestler_id: parseInt(wrestlerId) })
            });
            
            if (response.ok) {
                alert('Wrestler added to bracket');
                location.reload();
            } else {
                const error = await response.json();
                alert('Error: ' + error.error);
                e.target.value = '';
            }
        } catch (err) {
            alert('Error: ' + err.message);
            e.target.value = '';
        }
    });
});

// Mat tab filtering
document.querySelectorAll('.mat-tab').forEach(tab => {
    tab.addEventListener('click', () => {
        document.querySelectorAll('.mat-tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        
        const mat = tab.dataset.mat;
        document.querySelectorAll('.bracket-card').forEach(card => {
            if (mat === 'all' || card.dataset.mat === mat) {
                card.style.display = 'block';
            } else {
                card.style.display = 'none';
            }
        });
    });
});
</script>
{% endblock %}